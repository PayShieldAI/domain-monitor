openapi: 3.0.3
info:
  title: Domain Monitor API
  description: |
    Production-grade microservice for monitoring merchant web presence.

    ## Features
    - API key-based authentication for secure machine-to-machine communication
    - Domain monitoring with configurable check frequencies (7, 30, or 90 days)
    - Bulk operations support
    - Multi-provider architecture (TrueBiz primary)
    - Real-time updates via SSE (coming soon)
    - Webhook notifications

    ## Authentication

    ### API Key Authentication
    All endpoints require API key authentication via the `X-API-Key` header:
    ```
    X-API-Key: dmk_your_api_key_here
    ```

    API keys provide system-level access and are managed by superadmins.
    See the API Keys section for management endpoints.

    ## Quick Start Examples

    ### Example 1: Accessing Protected Endpoints
    ```bash
    # Access domains with API key
    curl -X GET https://dev-domainmonitor.ipo-servers.net/api/v1/domains \
      -H "X-API-Key: dmk_your_api_key_here"
    ```

    ### Example 2: Creating a Domain
    ```bash
    # Create a new domain for monitoring
    curl -X POST https://dev-domainmonitor.ipo-servers.net/api/v1/domains \
      -H "X-API-Key: dmk_your_api_key_here" \
      -H "Content-Type: application/json" \
      -d '{
        "domain": "example.com",
        "name": "Example Domain",
        "checkFrequency": "7"
      }'
    ```

    ### Example 3: Generate User Token via API Key
    ```bash
    # External system generating JWT for a user
    curl -X POST https://dev-domainmonitor.ipo-servers.net/api/v1/auth/generate-user-token \
      -H "X-API-Key: dmk_your_api_key_here" \
      -H "Content-Type: application/json" \
      -d '{"userId": "user-uuid-here"}'
    ```

  version: 1.0.0
  contact:
    name: API Support
    url: https://dev-domainmonitor.ipo-servers.net
  license:
    name: Proprietary

servers:
  - url: https://dev-domainmonitor.ipo-servers.net
    description: Development server
  - url: https://uat-monitor.payshield.ai
    description: UAT server
  - url: https://monitor.payshield.ai
    description: Production server

tags:
  - name: Health
    description: Health check endpoints
  - name: Authentication
    description: User authentication and authorization
  - name: Users
    description: User profile management
  - name: Domains
    description: Domain monitoring operations
  - name: User Webhooks
    description: Register webhooks to receive domain event notifications
  - name: Webhook Events
    description: View incoming webhook events from providers (Superadmin/API Key only)
  - name: Providers
    description: Provider management (Superadmin only)
  - name: API Keys
    description: API key management for machine-to-machine authentication (Superadmin only)

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for machine-to-machine authentication. Use format 'dmk_your_api_key_here'

  schemas:
    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: VALIDATION_ERROR
            message:
              type: string
              example: Validation failed
            details:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                  message:
                    type: string

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        role:
          type: string
          enum: [superadmin, reseller, merchant]
        status:
          type: string
          enum: [active, inactive, pending_verification]
        emailVerifiedAt:
          type: string
          format: date-time
          nullable: true
        lastLoginAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Domain:
      type: object
      properties:
        id:
          type: string
          format: uuid
        domain:
          type: string
          example: example.com
        name:
          type: string
          nullable: true
          example: Example Corp
        status:
          type: string
          enum: [active, inactive]
        recommendation:
          type: string
          enum: [pass, fail, review]
          nullable: true
        industry:
          type: string
          nullable: true
        businessType:
          type: string
          nullable: true
        foundedYear:
          type: integer
          nullable: true
        provider:
          type: string
          nullable: true
        checkFrequency:
          type: string
          enum: ['7', '30', '90']
          description: |
            Monitoring frequency in days:
            - '7': Weekly monitoring (every 7 days)
            - '30': Monthly monitoring (every 30 days)
            - '90': Quarterly monitoring (every 90 days)

            This value is sent to the monitoring provider (e.g., TrueBiz) to configure the monitoring package frequency.
        lastCheckedAt:
          type: string
          format: date-time
          nullable: true
        nextCheckAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Provider:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: truebiz
        displayName:
          type: string
          example: TrueBiz API
        enabled:
          type: boolean
        priority:
          type: integer
          description: Lower value = higher priority
        apiBaseUrl:
          type: string
          format: uri
        apiKeyMasked:
          type: string
          example: sk_t****
          description: Masked API key (last 4 chars visible)
        webhookSecretMasked:
          type: string
          example: '****abc123'
          description: Masked webhook secret (last 4 chars visible)
        rateLimit:
          type: integer
          description: Requests per minute
        timeout:
          type: integer
          description: Timeout in milliseconds
        config:
          type: object
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Pagination:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        totalPages:
          type: integer
        hasNext:
          type: boolean
        hasPrev:
          type: boolean

    ApiKey:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          description: Descriptive name for the API key
        keyPrefix:
          type: string
          description: First 12 characters of the key for identification
          example: "dmk_a1b2c3d4"
        permissions:
          type: array
          items:
            type: string
          description: Array of permission scopes
          nullable: true
        description:
          type: string
          description: Purpose and usage notes
          nullable: true
        lastUsedAt:
          type: string
          format: date-time
          nullable: true
          description: Last time this API key was used for authentication
        expiresAt:
          type: string
          format: date-time
          nullable: true
          description: Optional expiration date
        revokedAt:
          type: string
          format: date-time
          nullable: true
          description: When the key was revoked (null if active)
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          nullable: true
        createdBy:
          type: object
          nullable: true
          description: User who created this API key
          properties:
            email:
              type: string
              format: email
            name:
              type: string
              nullable: true

    WebhookEndpoint:
      type: object
      properties:
        id:
          type: string
          format: uuid
        url:
          type: string
          format: uri
          example: https://your-app.com/webhooks
        events:
          type: array
          nullable: true
          items:
            type: string
          example: ["business-closed", "sentiment"]
          description: Subscribed event types. null means all events.
        description:
          type: string
          nullable: true
        enabled:
          type: boolean
        lastDeliveryAt:
          type: string
          format: date-time
          nullable: true
        failedDeliveries:
          type: integer
          description: Consecutive failed delivery count
        totalDeliveries:
          type: integer
        successfulDeliveries:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    WebhookDelivery:
      type: object
      properties:
        id:
          type: string
          format: uuid
        eventType:
          type: string
          example: business-closed
        domainId:
          type: string
          format: uuid
          nullable: true
        attemptNumber:
          type: integer
        status:
          type: string
          enum: [pending, success, failed, retrying]
        responseStatus:
          type: integer
          nullable: true
          example: 200
        durationMs:
          type: integer
          nullable: true
          example: 245
        errorMessage:
          type: string
          nullable: true
        sentAt:
          type: string
          format: date-time
          nullable: true
        completedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    WebhookEvent:
      type: object
      properties:
        id:
          type: string
          format: uuid
        provider:
          type: string
          example: truebiz
          description: Provider name that sent the webhook
        event_type:
          type: string
          example: domain.verified
          description: Event type from the provider
        domain_id:
          type: string
          format: uuid
          nullable: true
          description: Associated domain ID (if matched)
        payload:
          type: object
          description: Raw webhook payload from provider
        signature:
          type: string
          nullable: true
          description: Webhook signature for verification
        verified:
          type: boolean
          description: Whether signature was verified
        processed:
          type: boolean
          description: Whether webhook was successfully processed
        processed_at:
          type: string
          format: date-time
          nullable: true
          description: When webhook was processed
        error_message:
          type: string
          nullable: true
          description: Error message if processing failed
        received_at:
          type: string
          format: date-time
          description: When webhook was received

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check the health status of the API and database connection
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                  checks:
                    type: object
                    properties:
                      database:
                        type: string
                        example: ok
        '503':
          description: Service is degraded
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: degraded
                  checks:
                    type: object

  /api/v1/auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                  pattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$'
                  description: Must contain uppercase, lowercase, and number
                name:
                  type: string
                role:
                  type: string
                  enum: [superadmin, reseller, merchant]
                  default: merchant
                  description: User role. Defaults to 'merchant' if not specified.
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      userId:
                        type: string
                        format: uuid
                      email:
                        type: string
                      name:
                        type: string
                      role:
                        type: string
                        enum: [superadmin, reseller, merchant]
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      accessToken:
                        type: string
                      refreshToken:
                        type: string
                      expiresIn:
                        type: integer
                        example: 900
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
      responses:
        '200':
          description: Token refreshed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      accessToken:
                        type: string
                      refreshToken:
                        type: string
                      expiresIn:
                        type: integer
        '401':
          description: Invalid refresh token

  /api/v1/auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '401':
          description: Unauthorized

  /api/v1/auth/forgot-password:
    post:
      tags:
        - Authentication
      summary: Request password reset
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Password reset email sent (if email exists)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /api/v1/auth/reset-password:
    post:
      tags:
        - Authentication
      summary: Reset password with token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - password
              properties:
                token:
                  type: string
                password:
                  type: string
                  minLength: 8
                  pattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$'
      responses:
        '200':
          description: Password reset successful
        '400':
          description: Invalid or expired token

  /api/v1/auth/change-password:
    post:
      tags:
        - Authentication
      summary: Change password
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - currentPassword
                - newPassword
              properties:
                currentPassword:
                  type: string
                newPassword:
                  type: string
                  minLength: 8
                  pattern: '^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$'
      responses:
        '200':
          description: Password changed successfully
        '400':
          description: Current password incorrect
        '401':
          description: Unauthorized

  /api/v1/auth/generate-user-token:
    post:
      tags:
        - Authentication
      summary: Generate JWT token for any user (Superadmin or API Key)
      description: |
        Allows a superadmin (via JWT) or system with API key to generate a JWT access token for any user.
        This is useful for:
        - Support scenarios (superadmin helping users)
        - Testing purposes (superadmin creating test tokens)
        - Machine-to-machine flows (external systems generating user tokens via API key)

        The generated token is a standard JWT that can be used for authentication.

        **Authentication Options:**
        - JWT Bearer token (requires superadmin role)
        - API Key via X-API-Key header (system-level access)
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                  format: uuid
                  description: The UUID of the user to generate a token for
                  example: "123e4567-e89b-12d3-a456-426614174000"
            examples:
              superadminRequest:
                summary: Request from superadmin via JWT
                value:
                  userId: "123e4567-e89b-12d3-a456-426614174000"
              apiKeyRequest:
                summary: Request from external system via API Key
                value:
                  userId: "987e6543-e21b-43d3-a456-426614174999"
      responses:
        '200':
          description: Token generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Token generated successfully
                  data:
                    type: object
                    properties:
                      accessToken:
                        type: string
                        description: JWT access token for the user
                      expiresIn:
                        type: integer
                        description: Token expiry time in seconds
                        example: 900
                      user:
                        type: object
                        properties:
                          id:
                            type: string
                            format: uuid
                          email:
                            type: string
                            format: email
                          role:
                            type: string
                            enum: [superadmin, reseller, merchant]
                          name:
                            type: string
                            nullable: true
        '401':
          description: Unauthorized - Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - Superadmin access required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/users/me:
    get:
      tags:
        - Users
      summary: Get current user profile
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized

    patch:
      tags:
        - Users
      summary: Update current user profile
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
        '409':
          description: Email already in use

  /api/v1/domains:
    get:
      tags:
        - Domains
      summary: List domains
      security:
        - ApiKeyAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Page number
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 1000
          description: Number of items per page
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive]
          description: Filter by domain status
        - name: recommendation
          in: query
          schema:
            type: string
            enum: [pass, fail, review]
          description: Filter by recommendation status
        - name: domain
          in: query
          schema:
            type: string
            maxLength: 255
          description: Filter by domain name (partial match)
        - name: name
          in: query
          schema:
            type: string
            maxLength: 255
          description: Filter by business name (partial match)
        - name: industry
          in: query
          schema:
            type: string
            maxLength: 255
          description: Filter by industry
        - name: businessType
          in: query
          schema:
            type: string
            maxLength: 255
          description: Filter by business type
        - name: foundedYear
          in: query
          schema:
            type: integer
            minimum: 1800
          description: Filter by founded year
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [created_at, updated_at, domain, name, recommendation, last_checked_at, industry, business_type, founded_year]
            default: created_at
          description: Field to sort by
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          description: Sort order
      responses:
        '200':
          description: List of domains
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Domain'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
                  filters:
                    type: object

    post:
      tags:
        - Domains
      summary: Add a domain
      description: |
        Add a domain or business to monitor. Either `domain` or `name` (business name) is required.

        Superadmins and resellers can optionally specify a `userId` to add domains on behalf of a merchant user.

        Additional business information (address, contact details) can be provided for better matching.

        Monitoring frequency in days:
                    - '7': Weekly monitoring (every 7 days)
                    - '30': Monthly monitoring (every 30 days)
                    - '90': Quarterly monitoring (every 90 days)

        If not provided (null/empty), no ongoing monitoring will be started - only a one-time domain/company check is performed.
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                domain:
                  type: string
                  maxLength: 255
                  example: example.com
                  description: Domain name (required if name not provided)
                name:
                  type: string
                  maxLength: 255
                  example: "Bob's Burritos"
                  description: Business name (required if domain not provided)
                description:
                  type: string
                  maxLength: 1000
                  example: A family-owned burrito restaurant serving authentic Mexican cuisine
                  description: Business description
                website:
                  type: string
                  format: uri
                  maxLength: 500
                  example: https://example.com
                  description: Full website URL
                addressLine1:
                  type: string
                  maxLength: 255
                  example: 123 Main Street
                  description: Street address line 1
                addressLine2:
                  type: string
                  maxLength: 255
                  example: Suite 100
                  description: Street address line 2
                city:
                  type: string
                  maxLength: 100
                  example: San Francisco
                  description: City
                stateProvince:
                  type: string
                  maxLength: 100
                  example: CA
                  description: State or province
                postalCode:
                  type: string
                  maxLength: 20
                  example: "94102"
                  description: Postal/ZIP code
                country:
                  type: string
                  maxLength: 100
                  example: USA
                  description: Country
                email:
                  type: string
                  format: email
                  maxLength: 255
                  example: contact@example.com
                  description: Contact email
                phone:
                  type: string
                  maxLength: 50
                  example: "+1-555-123-4567"
                  description: Contact phone number
                fullName:
                  type: string
                  maxLength: 255
                  example: John Doe
                  description: Contact person full name
                externalTrackingRef:
                  type: string
                  maxLength: 255
                  example: MERCH-12345
                  description: External tracking reference ID
                checkFrequency:
                  type: string
                  enum: ['7', '30', '90']
                  nullable: true
                  description: |
                    Monitoring frequency in days:
                    - '7': Weekly monitoring (every 7 days)
                    - '30': Monthly monitoring (every 30 days)
                    - '90': Quarterly monitoring (every 90 days)

                    If not provided (null/empty), no ongoing monitoring will be started - only a one-time domain/company check is performed.
                    When provided, this value is sent to the monitoring provider (e.g., TrueBiz) to configure the monitoring package frequency.
                userId:
                  type: string
                  format: uuid
                  description: |
                    (Superadmin/Reseller only) User ID of the merchant to add domain for.
                    If not provided, domain is added to the authenticated user's account.
      responses:
        '201':
          description: Domain added
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Domain'
        '409':
          description: Domain already exists
        '422':
          description: Validation error

  /api/v1/domains/bulk:
    post:
      tags:
        - Domains
      summary: Add multiple domains
      description: |
        Add multiple domains/businesses in a single request. Each item requires either `domain` or `name`.

        The response includes both creation results and provider check results.

        Superadmins and resellers can optionally specify a `userId` to add domains on behalf of a merchant user.
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - domains
              properties:
                domains:
                  type: array
                  minItems: 1
                  maxItems: 100
                  items:
                    type: object
                    properties:
                      domain:
                        type: string
                        maxLength: 255
                        description: Domain name (required if name not provided)
                      name:
                        type: string
                        maxLength: 255
                        description: Business name (required if domain not provided)
                      description:
                        type: string
                        maxLength: 1000
                      website:
                        type: string
                        format: uri
                        maxLength: 500
                      addressLine1:
                        type: string
                        maxLength: 255
                      addressLine2:
                        type: string
                        maxLength: 255
                      city:
                        type: string
                        maxLength: 100
                      stateProvince:
                        type: string
                        maxLength: 100
                      postalCode:
                        type: string
                        maxLength: 20
                      country:
                        type: string
                        maxLength: 100
                      email:
                        type: string
                        format: email
                        maxLength: 255
                      phone:
                        type: string
                        maxLength: 50
                      fullName:
                        type: string
                        maxLength: 255
                      externalTrackingRef:
                        type: string
                        maxLength: 255
                      checkFrequency:
                        type: string
                        enum: ['7', '30', '90']
                        nullable: true
                        description: |
                          Monitoring frequency in days:
                          - '7': Weekly monitoring (every 7 days)
                          - '30': Monthly monitoring (every 30 days)
                          - '90': Quarterly monitoring (every 90 days)

                          If not provided (null/empty), no ongoing monitoring will be started - only a one-time domain/company check is performed.
                          When provided, this value is sent to the monitoring provider (e.g., TrueBiz) to configure the monitoring package frequency.
                userId:
                  type: string
                  format: uuid
                  description: |
                    (Superadmin/Reseller only) User ID of the merchant to add domains for.
                    If not provided, domains are added to the authenticated user's account.
      responses:
        '201':
          description: Bulk operation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: array
                    description: Successfully created domains
                    items:
                      $ref: '#/components/schemas/Domain'
                  failed:
                    type: array
                    description: Domains that failed to create
                    items:
                      type: object
                      properties:
                        domain:
                          type: string
                        error:
                          type: string
                  total:
                    type: integer
                    description: Total domains in request
                  successCount:
                    type: integer
                    description: Number of successfully created domains
                  failedCount:
                    type: integer
                    description: Number of domains that failed to create
                  providerChecks:
                    type: object
                    description: Results of provider API checks for created domains
                    properties:
                      checked:
                        type: integer
                        description: Number of domains successfully checked by provider
                      failed:
                        type: integer
                        description: Number of domains where provider check failed
                      failures:
                        type: array
                        description: Details of failed provider checks
                        items:
                          type: object
                          properties:
                            domainId:
                              type: string
                              format: uuid
                            domain:
                              type: string
                            error:
                              type: string

  /api/v1/domains/bulk/retrieve:
    post:
      tags:
        - Domains
      summary: Retrieve multiple domains by IDs
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ids
              properties:
                ids:
                  type: array
                  minItems: 1
                  maxItems: 100
                  items:
                    type: string
                    format: uuid
      responses:
        '200':
          description: Domains retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  domains:
                    type: array
                    items:
                      $ref: '#/components/schemas/Domain'
                  notFound:
                    type: array
                    items:
                      type: string

  /api/v1/domains/{id}:
    get:
      tags:
        - Domains
      summary: Get domain by ID
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Domain details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Domain'
        '404':
          description: Domain not found

  /api/v1/domains/{id}/details:
    get:
      tags:
        - Domains
      summary: Get domain with full raw data
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Domain details with raw data
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    allOf:
                      - $ref: '#/components/schemas/Domain'
                      - type: object
                        properties:
                          rawData:
                            type: object
                          providerResponseId:
                            type: string

 
  /api/v1/domains/{id}/check:
    post:
      tags:
        - Domains
      summary: Manually trigger domain verification check
      description: |
        Manually trigger a domain verification check with the provider and update the domain table with the results.

        This endpoint reuses the same verification logic that runs when a domain is created.
        The check results (recommendation, business info, etc.) are automatically saved to the domain record.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Domain ID
      responses:
        '200':
          description: Domain check completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Domain verification check completed successfully
                  data:
                    $ref: '#/components/schemas/Domain'
        '404':
          description: Domain not found
        '401':
          description: Unauthorized

  /api/v1/domains/{id}/stop:
    patch:
      tags:
        - Domains
      summary: Stop monitoring domain
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Monitoring stopped
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Domain'

  /api/v1/domains/{id}/start:
    patch:
      tags:
        - Domains
      summary: Start monitoring domain
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Monitoring started
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Domain'

  /api/v1/domains/bulk/stop:
    patch:
      tags:
        - Domains
      summary: Stop monitoring multiple domains
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ids
              properties:
                ids:
                  type: array
                  minItems: 1
                  maxItems: 100
                  items:
                    type: string
                    format: uuid
      responses:
        '200':
          description: Bulk stop result
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated:
                    type: array
                    items:
                      type: string
                  notFound:
                    type: array
                    items:
                      type: string
                  message:
                    type: string

  /api/v1/domains/bulk/start:
    patch:
      tags:
        - Domains
      summary: Start monitoring multiple domains
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ids
              properties:
                ids:
                  type: array
                  minItems: 1
                  maxItems: 100
                  items:
                    type: string
                    format: uuid
      responses:
        '200':
          description: Bulk start result
          content:
            application/json:
              schema:
                type: object
                properties:
                  updated:
                    type: array
                    items:
                      type: string
                  notFound:
                    type: array
                    items:
                      type: string
                  message:
                    type: string

  /api/v1/user-webhooks:
    get:
      tags:
        - User Webhooks
      summary: List webhook endpoints
      description: |
        Get all registered webhook endpoints for the authenticated user.

        **Admin Access:**
        Superadmins, resellers, and API key holders can specify a `userId` query parameter to list webhooks for other users.
      security:        
        - ApiKeyAuth: []
      parameters:
        - name: userId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional. Target user ID (superadmin/reseller/API key only). If omitted, lists webhooks for the authenticated user.
      responses:
        '200':
          description: Webhook endpoints retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Webhook endpoints retrieved successfully
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/WebhookEndpoint'
        '401':
          description: Unauthorized

    post:
      tags:
        - User Webhooks
      summary: Register webhook endpoint
      description: |
        Register a new webhook endpoint to receive domain event notifications.

        **Event Types:**
        - 

        **Subscribe to all events:** Omit the `events` field or set it to `null` to receive all events.

        **Webhook Signature Verification:**
        The secret returned on creation is used to sign webhook payloads using HMAC-SHA256.
        Verify the signature in the `X-Webhook-Signature` header to ensure authenticity.

        **Admin Access:**
        Superadmins, resellers, and API key holders can specify a `userId` to create webhooks for other users.
        Merchants can only create webhooks for themselves.
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - url
              properties:
                userId:
                  type: string
                  format: uuid
                  example: 550e8400-e29b-41d4-a716-446655440000
                  description: |
                    Target user ID for the webhook endpoint.
                    - **Required when using API key authentication** (API keys are system-level and not tied to a specific user)
                    - **Optional for JWT authentication** (defaults to the authenticated user's ID)
                    - Superadmins and resellers can specify any userId
                    - Regular merchants cannot specify userId (will be ignored and use their own ID)
                url:
                  type: string
                  format: uri
                  maxLength: 2048
                  example: https://your-app.com/webhooks/domain-monitor
                  description: HTTPS URL to receive webhook events
                events:
                  type: array
                  nullable: true
                  items:
                    type: string
                    enum:
                      - domain.created
                      - business-profile
                      - domain.deleted
                      - business-closed
                      - sentiment
                      - website
                  example: ["business-closed", "sentiment"]
                  description: Event types to subscribe to. Omit or set to null to receive all events.
                description:
                  type: string
                  maxLength: 500
                  example: Production webhook endpoint
      responses:
        '201':
          description: Webhook endpoint created
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Webhook endpoint created successfully
                  warning:
                    type: string
                    example: Store the secret securely. It will not be shown again.
                  data:
                    allOf:
                      - $ref: '#/components/schemas/WebhookEndpoint'
                      - type: object
                        properties:
                          secret:
                            type: string
                            example: whsec_abc123def456...
                            description: Webhook signing secret (only shown once)
        '400':
          description: Validation error
        '401':
          description: Unauthorized

  /api/v1/user-webhooks/{id}:
    get:
      tags:
        - User Webhooks
      summary: Get webhook endpoint
      description: |
        Retrieve details of a specific webhook endpoint.

        **Admin Access:**
        Superadmins, resellers, and API key holders can specify a `userId` query parameter to view webhooks for other users.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: userId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional. Target user ID (superadmin/reseller/API key only). If omitted, retrieves webhook for the authenticated user.
      responses:
        '200':
          description: Webhook endpoint retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Webhook endpoint retrieved successfully
                  data:
                    $ref: '#/components/schemas/WebhookEndpoint'
        '404':
          description: Webhook endpoint not found
        '401':
          description: Unauthorized

    patch:
      tags:
        - User Webhooks
      summary: Update webhook endpoint
      description: |
        Update webhook endpoint configuration. All fields are optional.

        **Admin Access:**
        Superadmins, resellers, and API key holders can specify a `userId` to update webhooks for other users.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userId:
                  type: string
                  format: uuid
                  description: Optional. Target user ID (superadmin/reseller/API key only). If omitted, updates webhook for the authenticated user.
                url:
                  type: string
                  format: uri
                  maxLength: 2048
                events:
                  type: array
                  nullable: true
                  items:
                    type: string
                    enum:
                      - domain.created
                      - business-profile
                      - domain.deleted
                      - business-closed
                      - sentiment
                      - website
                  description: Event types to subscribe to. Set to null for all events.
                description:
                  type: string
                  maxLength: 500
                enabled:
                  type: boolean
                  description: Enable or disable the webhook endpoint
      responses:
        '200':
          description: Webhook endpoint updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Webhook endpoint updated successfully
                  data:
                    $ref: '#/components/schemas/WebhookEndpoint'
        '400':
          description: Validation error
        '404':
          description: Webhook endpoint not found
        '401':
          description: Unauthorized

    delete:
      tags:
        - User Webhooks
      summary: Delete webhook endpoint
      description: |
        Remove a webhook endpoint. This action cannot be undone.

        **Admin Access:**
        Superadmins, resellers, and API key holders can specify a `userId` query parameter to delete webhooks for other users.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: userId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional. Target user ID (superadmin/reseller/API key only). If omitted, deletes webhook for the authenticated user.
      responses:
        '200':
          description: Webhook endpoint deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Webhook endpoint deleted successfully
        '404':
          description: Webhook endpoint not found
        '401':
          description: Unauthorized

  /api/v1/user-webhooks/{id}/test:
    post:
      tags:
        - User Webhooks
      summary: Test webhook endpoint
      description: |
        Send a test webhook to verify the endpoint is working.
        This sends a sample `business-closed` event to your endpoint.

        **Admin Access:**
        Superadmins, resellers, and API key holders can specify a `userId` to test webhooks for other users.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                userId:
                  type: string
                  format: uuid
                  description: Optional. Target user ID (superadmin/reseller/API key only). If omitted, tests webhook for the authenticated user.
      responses:
        '200':
          description: Test webhook sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Test webhook sent successfully
                  data:
                    type: object
                    properties:
                      success:
                        type: boolean
                      status:
                        type: integer
                        example: 200
                        description: HTTP response status from your endpoint
                      deliveryLogId:
                        type: string
                        format: uuid
                        description: Delivery log ID for tracking
        '404':
          description: Webhook endpoint not found
        '401':
          description: Unauthorized

  /api/v1/user-webhooks/{id}/regenerate-secret:
    post:
      tags:
        - User Webhooks
      summary: Regenerate webhook secret
      description: |
        Generate a new signing secret for the webhook endpoint.
        The old secret will be immediately invalidated.
        Update your webhook handler with the new secret.

        **Admin Access:**
        Superadmins, resellers, and API key holders can specify a `userId` to regenerate secrets for other users' webhooks.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                userId:
                  type: string
                  format: uuid
                  description: Optional. Target user ID (superadmin/reseller/API key only). If omitted, regenerates secret for the authenticated user's webhook.
      responses:
        '200':
          description: Secret regenerated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Secret regenerated successfully. Update your webhook handler with the new secret.
                  data:
                    type: object
                    properties:
                      secret:
                        type: string
                        example: whsec_new123abc456...
                        description: New webhook signing secret
        '404':
          description: Webhook endpoint not found
        '401':
          description: Unauthorized

  /api/v1/user-webhooks/{id}/deliveries:
    get:
      tags:
        - User Webhooks
      summary: View webhook delivery logs
      description: |
        Get delivery logs for a webhook endpoint.
        Useful for debugging webhook delivery issues.

        **Admin Access:**
        Superadmins, resellers, and API key holders can specify a `userId` query parameter to view delivery logs for other users' webhooks.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: userId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Optional. Target user ID (superadmin/reseller/API key only). If omitted, retrieves logs for the authenticated user's webhook.
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            maximum: 500
          description: Number of delivery logs to retrieve
      responses:
        '200':
          description: Delivery logs retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Delivery logs retrieved successfully
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/WebhookDelivery'
        '404':
          description: Webhook endpoint not found
        '401':
          description: Unauthorized

  /api/v1/user-webhooks/deliveries:
    get:
      tags:
        - User Webhooks
      summary: List all delivery logs
      description: |
        Get all webhook delivery logs with optional filters.

        **Access Control:**
        - **Superadmin/API key**: Can query all deliveries or filter by any `userId`
        - **Reseller**: Can only see deliveries for their assigned merchants. If `userId` is specified, it must be a merchant assigned to them
        - **Merchant**: Can only see their own deliveries (cannot use `userId` filter)
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: userId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Filter by user ID. Superadmin/API key can use any userId. Resellers can only filter by their assigned merchants.
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Page number
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
          description: Number of items per page
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, success, failed, retrying]
          description: Filter by delivery status
        - name: dateFrom
          in: query
          schema:
            type: string
            format: date-time
          description: Filter deliveries from this date (ISO 8601 format, e.g., 2025-01-01 or 2025-01-01T00:00:00Z)
        - name: dateTo
          in: query
          schema:
            type: string
            format: date-time
          description: Filter deliveries until this date (ISO 8601 format, e.g., 2025-01-31 or 2025-01-31T23:59:59Z)
        - name: domainId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by domain ID
      responses:
        '200':
          description: Delivery logs retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Delivery logs retrieved successfully
                  data:
                    type: array
                    items:
                      allOf:
                        - $ref: '#/components/schemas/WebhookDelivery'
                        - type: object
                          properties:
                            endpointId:
                              type: string
                              format: uuid
                            endpointUrl:
                              type: string
                              format: uri
                            userId:
                              type: string
                              format: uuid
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          description: Unauthorized
  /api/v1/webhooks:
    get:
      tags:
        - Webhook Events
      summary: List provider webhook events
      description: |
        Get all webhook events received from providers with filtering capabilities.

        This endpoint shows incoming webhooks from external providers (like TrueBiz), not outgoing
        webhooks to user endpoints. Use this for debugging provider integrations and monitoring
        webhook delivery status.

        **Requires:** Superadmin role or API Key authentication
      security:
        - BearerAuth: []
        - ApiKeyAuth: []
      parameters:
        - name: provider
          in: query
          schema:
            type: string
            maxLength: 50
          description: Filter by provider name (e.g., "truebiz")
          example: truebiz
        - name: domainId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by associated domain ID
        - name: status
          in: query
          schema:
            type: boolean
          description: Filter by processing status (true = processed, false = failed/pending)
          example: true
        - name: dateFrom
          in: query
          schema:
            type: string
            format: date-time
          description: Filter webhooks received from this date (ISO 8601 format)
          example: "2026-01-01T00:00:00Z"
        - name: dateTo
          in: query
          schema:
            type: string
            format: date-time
          description: Filter webhooks received until this date (ISO 8601 format)
          example: "2026-01-27T23:59:59Z"
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Number of results per page
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Pagination offset
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number (alternative to offset)
      responses:
        '200':
          description: List of webhook events
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/WebhookEvent'
                  pagination:
                    type: object
                    properties:
                      total:
                        type: integer
                        description: Total number of matching webhooks
                        example: 150
                      limit:
                        type: integer
                        example: 20
                      offset:
                        type: integer
                        example: 0
                      page:
                        type: integer
                        example: 1
                      totalPages:
                        type: integer
                        example: 8
              examples:
                filtered:
                  summary: Filtered by provider
                  value:
                    success: true
                    data:
                      - id: "123e4567-e89b-12d3-a456-426614174000"
                        provider: "truebiz"
                        event_type: "domain.verified"
                        domain_id: "987e6543-e21b-43d3-a456-426614174999"
                        payload:
                          type: "domain.verified"
                          data:
                            domain: "example.com"
                        signature: "sha256=abc123..."
                        verified: true
                        processed: true
                        processed_at: "2026-01-27T10:00:00Z"
                        error_message: null
                        received_at: "2026-01-27T09:59:00Z"
                    pagination:
                      total: 45
                      limit: 20
                      offset: 0
                      page: 1
                      totalPages: 3
        '401':
          description: Unauthorized - Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - Superadmin or API Key access required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Validation error - Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/admin/providers:
    get:
      tags:
        - Providers
      summary: List all providers
      description: Get all providers with their configuration (API keys masked). Requires superadmin role.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: enabled
          in: query
          schema:
            type: boolean
          description: Filter by enabled status
      responses:
        '200':
          description: List of providers
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Provider'
        '401':
          description: Unauthorized
        '403':
          description: Superadmin access required

    post:
      tags:
        - Providers
      summary: Create a new provider
      description: Create a new provider with encrypted API key. Requires superadmin role.
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - displayName
                - apiBaseUrl
                - apiKey
              properties:
                name:
                  type: string
                  pattern: '^[a-z0-9_-]+$'
                  minLength: 2
                  maxLength: 50
                  example: truebiz
                displayName:
                  type: string
                  minLength: 2
                  maxLength: 100
                  example: TrueBiz API
                apiBaseUrl:
                  type: string
                  format: uri
                  example: https://api.truebiz.com/v1
                apiKey:
                  type: string
                  minLength: 10
                  maxLength: 500
                  example: sk_test_123456789
                enabled:
                  type: boolean
                  default: true
                priority:
                  type: integer
                  minimum: 1
                  maximum: 1000
                  default: 100
                rateLimit:
                  type: integer
                  minimum: 1
                  maximum: 10000
                  default: 60
                timeout:
                  type: integer
                  minimum: 1000
                  maximum: 60000
                  default: 10000
                config:
                  type: object
      responses:
        '201':
          description: Provider created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Provider'
        '409':
          description: Provider already exists
        '422':
          description: Validation error

  /api/v1/admin/providers/{id}:
    get:
      tags:
        - Providers
      summary: Get provider by ID
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Provider details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Provider'
        '404':
          description: Provider not found

    patch:
      tags:
        - Providers
      summary: Update provider
      description: |
        Update provider configuration. All fields are optional - only provide fields you want to update.

        **Security**:
        - `apiKey` and `webhookSecret` will be encrypted before storage
        - Masked versions are returned in responses
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              minProperties: 1
              properties:
                displayName:
                  type: string
                  minLength: 2
                  maxLength: 100
                apiBaseUrl:
                  type: string
                  format: uri
                apiKey:
                  type: string
                  minLength: 10
                  maxLength: 500
                  description: Provider API key (will be encrypted)
                webhookSecret:
                  type: string
                  minLength: 20
                  maxLength: 500
                  example: xxxxxxxxxxxxxxxxxxxxxxxxx
                  description: Webhook signing secret (will be encrypted)
                enabled:
                  type: boolean
                priority:
                  type: integer
                  minimum: 1
                  maximum: 1000
                rateLimit:
                  type: integer
                  minimum: 1
                  maximum: 10000
                timeout:
                  type: integer
                  minimum: 1000
                  maximum: 60000
                config:
                  type: object
      responses:
        '200':
          description: Provider updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Provider'
        '404':
          description: Provider not found
        '422':
          description: Validation error

    delete:
      tags:
        - Providers
      summary: Delete provider
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Provider deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '404':
          description: Provider not found

  /api/v1/admin/providers/name/{name}:
    get:
      tags:
        - Providers
      summary: Get provider by name
      security:
        - ApiKeyAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
            pattern: '^[a-z0-9_-]+$'
          example: truebiz
      responses:
        '200':
          description: Provider details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Provider'
        '404':
          description: Provider not found

  /api/v1/admin/providers/{id}/enable:
    patch:
      tags:
        - Providers
      summary: Enable provider
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Provider enabled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Provider'

  /api/v1/admin/providers/{id}/disable:
    patch:
      tags:
        - Providers
      summary: Disable provider
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Provider disabled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Provider'

  /api/v1/admin/providers/{id}/priority:
    patch:
      tags:
        - Providers
      summary: Update provider priority
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - priority
              properties:
                priority:
                  type: integer
                  minimum: 1
                  maximum: 1000
      responses:
        '200':
          description: Priority updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Provider'

  /api/v1/admin/providers/reload:
    post:
      tags:
        - Providers
      summary: Reload providers from database
      description: Reloads all providers from database into memory. Use after manual database changes.
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: Providers reloaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      count:
                        type: integer
                        description: Number of providers loaded
                      providers:
                        type: array
                        items:
                          type: string
                        description: List of provider names

  /api/v1/admin/providers/{id}/health:
    get:
      tags:
        - Providers
      summary: Check provider health
      description: Check if provider API is reachable and responding
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Health check result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      status:
                        type: string
                        enum: [ok, error]
                      provider:
                        type: string
                      error:
                        type: string
                        nullable: true
                      responseTime:
                        type: integer
                        description: Response time in milliseconds

  /api/v1/admin/api-keys:
    get:
      tags:
        - API Keys
      summary: List all API keys
      description: Retrieve all API keys with metadata. Requires superadmin role.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: includeRevoked
          in: query
          schema:
            type: boolean
            default: false
          description: Include revoked API keys in the response
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ApiKey'
        '401':
          description: Unauthorized
        '403':
          description: Superadmin access required

    post:
      tags:
        - API Keys
      summary: Create a new API key
      description: |
        Generate a new API key for machine-to-machine authentication.
        The API key is returned only once and cannot be retrieved again.
        Store it securely. Requires superadmin role.
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  minLength: 3
                  maxLength: 255
                  description: Descriptive name for the API key
                  example: "Payment Gateway Integration"
                description:
                  type: string
                  maxLength: 1000
                  description: Purpose and usage notes
                  example: "Used by the payment gateway to verify domains before processing"
                permissions:
                  type: array
                  items:
                    type: string
                  description: Array of permission scopes (optional, for future use)
                  example: ["domains:read", "domains:write"]
                expiresAt:
                  type: string
                  format: date-time
                  description: Optional expiration date (ISO 8601 format)
                  example: "2026-12-31T23:59:59Z"
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "API key created successfully"
                  warning:
                    type: string
                    example: "Store this API key securely. It will not be shown again."
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      apiKey:
                        type: string
                        description: The actual API key (only returned on creation)
                        example: "dmk_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"
                      keyPrefix:
                        type: string
                        description: First 12 characters for identification
                        example: "dmk_a1b2c3d4"
                      name:
                        type: string
                      permissions:
                        type: array
                        items:
                          type: string
                      description:
                        type: string
                        nullable: true
                      expiresAt:
                        type: string
                        format: date-time
                        nullable: true
                      createdAt:
                        type: string
                        format: date-time
        '400':
          description: Validation error
        '401':
          description: Unauthorized
        '403':
          description: Superadmin access required

  /api/v1/admin/api-keys/{id}:
    get:
      tags:
        - API Keys
      summary: Get API key details
      description: Retrieve details of a specific API key. Requires superadmin role.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: API key details
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/ApiKey'
        '404':
          description: API key not found
        '401':
          description: Unauthorized
        '403':
          description: Superadmin access required

    patch:
      tags:
        - API Keys
      summary: Update API key metadata
      description: Update name, description, permissions, or expiration. Cannot update revoked keys. Requires superadmin role.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  minLength: 3
                  maxLength: 255
                description:
                  type: string
                  maxLength: 1000
                permissions:
                  type: array
                  items:
                    type: string
                expiresAt:
                  type: string
                  format: date-time
                  nullable: true
      responses:
        '200':
          description: API key updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/ApiKey'
        '400':
          description: Cannot update revoked key
        '404':
          description: API key not found
        '401':
          description: Unauthorized
        '403':
          description: Superadmin access required

    delete:
      tags:
        - API Keys
      summary: Delete API key (hard delete)
      description: Permanently delete an API key from the database. Requires superadmin role.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: API key deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "API key deleted successfully"
        '404':
          description: API key not found
        '401':
          description: Unauthorized
        '403':
          description: Superadmin access required

  /api/v1/admin/api-keys/{id}/revoke:
    post:
      tags:
        - API Keys
      summary: Revoke API key (soft delete)
      description: |
        Revoke an API key, making it unusable without permanently deleting it.
        Revoked keys remain in the database for audit purposes. Requires superadmin role.
      security:
        - ApiKeyAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: API key revoked
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "API key revoked successfully"
        '400':
          description: API key is already revoked
        '404':
          description: API key not found
        '401':
          description: Unauthorized
        '403':
          description: Superadmin access required

