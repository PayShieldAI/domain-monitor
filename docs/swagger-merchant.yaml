openapi: 3.0.3
info:
  title: Domain Monitor API - Merchant Portal
  description: |
    Merchant-focused API for domain monitoring and verification.

    ## Overview
    This API allows merchants to monitor their domain reputation and verification status.
    All endpoints use JWT Bearer token authentication 

    ## Authentication
    All endpoints require JWT authentication.

    ```
    Authorization: Bearer <your_access_token>
    ```

  version: 1.0.0
  contact:
    email: support@domainmonitor.com

servers:
  - url: https://dev-domainmonitor.ipo-servers.net
    description: Development server
  - url: https://api.domainmonitor.com
    description: Production server
  - url: https://justin-dev-domainmonitor.ipo-servers.net
    description: Justin Development server

tags:
  
  - name: Domains
    description: Domain monitoring and management
  - name: User Webhooks
    description: Register webhooks to receive domain event notifications

paths:
 
  # ==========================================
  # DOMAINS
  # ==========================================
  /api/v1/domains:
    get:
      tags:
        - Domains
      summary: List all domains
      description: Get a list of all domains belonging to the authenticated merchant
      operationId: listDomains
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive]
          description: Filter by domain status
        - name: recommendation
          in: query
          schema:
            type: string
            enum: [pass, fail, review]
          description: Filter by recommendation status
        - name: industry
          in: query
          schema:
            type: string
            maxLength: 255
          description: Filter by industry
        - name: businessType
          in: query
          schema:
            type: string
            maxLength: 255
          description: Filter by business type
        - name: foundedYear
          in: query
          schema:
            type: integer
            minimum: 1800
          description: Filter by founded year
        - name: search
          in: query
          schema:
            type: string
            maxLength: 255
          description: Search by domain or name
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [created_at, updated_at, domain, name, recommendation, last_checked_at, industry, business_type, founded_year]
            default: created_at
          description: Field to sort by
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          description: Sort order
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Page number
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
          description: Number of items per page
      responses:
        '200':
          description: Domains retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Domains retrieved successfully
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Domain'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    post:
      tags:
        - Domains
      summary: Add a new domain
      description: Register a new domain for monitoring
      operationId: createDomain
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - domain
              properties:
                domain:
                  type: string
                  example: example.com
                  description: Domain name without protocol
                name:
                  type: string
                  example: My Business Website
                  description: Friendly name for the domain
                checkFrequency:
                  type: string
                  enum: ['7', '30', '90']
                  default: '7'
                  description: |
                    Monitoring frequency in days:
                    - '7': Weekly monitoring (every 7 days)
                    - '30': Monthly monitoring (every 30 days)
                    - '90': Quarterly monitoring (every 90 days)

                    This value is sent to the monitoring provider to configure the monitoring package frequency.
      responses:
        '201':
          description: Domain created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Domain created and verification initiated
                  data:
                    $ref: '#/components/schemas/Domain'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '409':
          description: Domain already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/domains/{id}:
    get:
      tags:
        - Domains
      summary: Get domain by ID
      description: Retrieve detailed information about a specific domain
      operationId: getDomainById
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Domain retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Domain'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/domains/{id}/details:
    get:
      tags:
        - Domains
      summary: Get domain verification details with raw provider data
      description: |
        Get comprehensive verification details including the complete raw response from the provider.

        **Important:** This endpoint returns the full raw JSON response from the verification provider
        in the `web_presence.rawData` field. This includes all data points collected during the
        web presence review.
      operationId: getDomainDetails
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Domain details with raw provider data retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    allOf:
                      - $ref: '#/components/schemas/Domain'
                      - type: object
                        properties:
                          web_presence:
                            type: object
                            properties:
                              recommendation:
                                type: string
                                enum: [pass, fail, review]
                              businessName:
                                type: string
                              industry:
                                type: string
                              businessType:
                                type: string
                              foundedYear:
                                type: integer
                              provider:
                                type: string
                              rawData:
                                type: object
                                description: Complete raw JSON response from the verification provider
                                nullable: true
                              providerResponseId:
                                type: string
                                description: Provider's unique response/transaction ID
                                nullable: true
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  
  /api/v1/domains/{id}/stop:
    patch:
      tags:
        - Domains
      summary: Stop monitoring domain
      description: Pause monitoring for this domain
      operationId: stopDomain
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Domain monitoring stopped
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Domain monitoring stopped
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/domains/{id}/start:
    patch:
      tags:
        - Domains
      summary: Start monitoring domain
      description: Resume monitoring for this domain
      operationId: startDomain
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Domain monitoring started
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Domain monitoring started
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  

  # ==========================================
  # USER WEBHOOKS
  # ==========================================
  /api/v1/user-webhooks:
    get:
      tags:
        - User Webhooks
      summary: List webhook endpoints
      description: Get all registered webhook endpoints for the authenticated merchant
      operationId: listWebhookEndpoints
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Webhook endpoints retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/WebhookEndpoint'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    
  /api/v1/user-webhooks/{id}:
    get:
      tags:
        - User Webhooks
      summary: Get webhook endpoint
      description: Retrieve details of a specific webhook endpoint
      operationId: getWebhookEndpoint
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Webhook endpoint retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/WebhookEndpoint'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    patch:
      tags:
        - User Webhooks
      summary: Update webhook endpoint
      description: Update webhook endpoint configuration
      operationId: updateWebhookEndpoint
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  format: uri
                events:
                  type: array
                  nullable: true
                  items:
                    type: string
                    enum:
                      - domain.created
                      - business-profile
                      - domain.deleted
                      - business-closed
                      - sentiment
                      - website
                description:
                  type: string
                  maxLength: 500
                enabled:
                  type: boolean
      responses:
        '200':
          description: Webhook endpoint updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/WebhookEndpoint'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    delete:
      tags:
        - User Webhooks
      summary: Delete webhook endpoint
      description: Remove a webhook endpoint
      operationId: deleteWebhookEndpoint
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Webhook endpoint deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Webhook endpoint deleted successfully
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/user-webhooks/{id}/test:
    post:
      tags:
        - User Webhooks
      summary: Test webhook endpoint
      description: Send a test webhook to verify the endpoint is working
      operationId: testWebhookEndpoint
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Test webhook sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Test webhook sent successfully
                  data:
                    type: object
                    properties:
                      status:
                        type: string
                        example: success
                      responseStatus:
                        type: integer
                        example: 200
                      durationMs:
                        type: integer
                        example: 245
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/user-webhooks/{id}/regenerate-secret:
    post:
      tags:
        - User Webhooks
      summary: Regenerate webhook secret
      description: Generate a new signing secret for the webhook endpoint
      operationId: regenerateWebhookSecret
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Secret regenerated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Webhook secret regenerated successfully
                  warning:
                    type: string
                    example: Store the new secret securely. It will not be shown again.
                  data:
                    type: object
                    properties:
                      secret:
                        type: string
                        example: new123...
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/user-webhooks/{id}/deliveries:
    get:
      tags:
        - User Webhooks
      summary: View webhook delivery logs
      description: Get delivery logs for a webhook endpoint
      operationId: getWebhookDeliveries
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Delivery logs retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/WebhookDelivery'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

# ==========================================
# COMPONENTS
# ==========================================
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token obtained from login endpoint

  schemas:
    Domain:
      type: object
      properties:
        id:
          type: string
          format: uuid
        domain:
          type: string
          example: example.com
        name:
          type: string
          example: My Business Website
        status:
          type: string
          enum: [active, inactive]
        recommendation:
          type: string
          enum: [pass, fail, review]
          nullable: true
        provider:
          type: string
          example: truebiz
        checkFrequency:
          type: string
          enum: ['7', '30', '90']
          description: |
            Monitoring frequency in days:
            - '7': Weekly monitoring (every 7 days)
            - '30': Monthly monitoring (every 30 days)
            - '90': Quarterly monitoring (every 90 days)

            This value is sent to the monitoring provider (e.g., TrueBiz) to configure the monitoring package frequency.
        lastCheckedAt:
          type: string
          format: date-time
          nullable: true
        nextCheckAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    WebhookEndpoint:
      type: object
      properties:
        id:
          type: string
          format: uuid
        url:
          type: string
          format: uri
          example: https://your-app.com/webhooks
        events:
          type: array
          nullable: true
          items:
            type: string
          example: ["business-closed", "sentiment"]
          description: Subscribed event types. null means all events.
        description:
          type: string
          nullable: true
        enabled:
          type: boolean
        lastDeliveryAt:
          type: string
          format: date-time
          nullable: true
        failedDeliveries:
          type: integer
          description: Consecutive failed delivery count
        totalDeliveries:
          type: integer
        successfulDeliveries:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    WebhookDelivery:
      type: object
      properties:
        id:
          type: string
          format: uuid
        eventType:
          type: string
          example: business-closed
        domainId:
          type: string
          format: uuid
          nullable: true
        attemptNumber:
          type: integer
        status:
          type: string
          enum: [pending, success, failed, retrying]
        responseStatus:
          type: integer
          nullable: true
          example: 200
        durationMs:
          type: integer
          nullable: true
          example: 245
        errorMessage:
          type: string
          nullable: true
        sentAt:
          type: string
          format: date-time
          nullable: true
        completedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    Pagination:
      type: object
      properties:
        limit:
          type: integer
        offset:
          type: integer
        total:
          type: integer

    Error:
      type: object
      properties:
        message:
          type: string
        code:
          type: string
        details:
          type: object

  responses:
    UnauthorizedError:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: Authentication required
            code: UNAUTHORIZED

    ValidationError:
      description: Validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: Validation failed
            code: VALIDATION_ERROR
            details:
              email: Email is required

    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: Resource not found
            code: NOT_FOUND

security:
  - BearerAuth: []
