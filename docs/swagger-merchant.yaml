openapi: 3.0.3
info:
  title: Domain Monitor API - Merchant Portal
  description: |
    Merchant-focused API for domain monitoring and verification.

    ## Overview

    This API allows merchants to monitor their domain reputation and verification status.

    When a domain is added, monitoring starts immediately and an initial web presence
    verification is attempted asynchronously. Verification depends on external providers
    and may fail, timeout, or return incomplete data. Monitoring continues regardless
    of verification outcome.

    All endpoints use JWT Bearer token authentication 

    ## Authentication
    All endpoints require JWT authentication.

    ```
    Authorization: Bearer <your_access_token>
    ```

  version: 1.0.0
  contact:
    email: sysadmin@payshield.ai

servers:
  - url: https://dev-domainmonitor.ipo-servers.net
    description: Development server
  - url: https://uat-monitor.payshield.ai
    description: UAT server
  - url: https://monitor.payshield.ai
    description: Production Server

tags:

  - name: Domains
    description: Domain monitoring and management
  - name: User Webhooks
    description: |
      Register webhooks to receive domain event notifications.

      Webhook events may be triggered by underlying verification provider signals
      and represent the latest known verification state for a domain.

      ## Webhook Security

      All webhooks sent by Domain Monitor include a cryptographic signature that you should verify to ensure the webhook is authentic and hasn't been tampered with.

      ### Signature Verification

      Each webhook request includes the following headers:
      - `X-Webhook-Signature`: HMAC-SHA256 signature in the format `sha256={hex_digest}`
      - `X-Webhook-Event`: The event type (e.g., `business-closed`, `sentiment`)
      - `X-Webhook-Delivery-Id`: Unique delivery ID for tracking
      - `User-Agent`: Always `DomainMonitor-Webhook/1.0`

      ### How to Verify the Signature

      1. Retrieve the signing secret for your webhook endpoint (provided when you register or regenerate the secret)
      2. Get the raw request body as a string
      3. Compute the HMAC-SHA256 signature:
         - Use your webhook secret as the key
         - Hash the raw request body exactly as received (before JSON parsing).
           Do not re-stringify parsed payloads, as this will invalidate the signature.
         - Format the result as `sha256={hex_digest}`
      4. Compare your computed signature with the `X-Webhook-Signature` header using a timing-safe comparison

      ### Example Verification Code

      **Node.js:**
      ```javascript
      const crypto = require('crypto');

      function verifyWebhookSignature(payload, signature, secret) {
        const hmac = crypto.createHmac('sha256', secret);
        hmac.update(JSON.stringify(payload));
        const expectedSignature = `sha256=${hmac.digest('hex')}`;

        // Use timing-safe comparison to prevent timing attacks
        return crypto.timingSafeEqual(
          Buffer.from(signature),
          Buffer.from(expectedSignature)
        );
      }

      // Express.js example
      app.post('/webhooks', express.json(), (req, res) => {
        const signature = req.headers['x-webhook-signature'];
        const secret = process.env.WEBHOOK_SECRET; // Your webhook secret

        if (!verifyWebhookSignature(req.body, signature, secret)) {
          return res.status(401).send('Invalid signature');
        }

        // Process webhook event
        const eventType = req.headers['x-webhook-event'];
        console.log('Received event:', eventType, req.body);

        res.status(200).send('OK');
      });
      ```

      **Python:**
      ```python
      import hmac
      import hashlib
      import json

      def verify_webhook_signature(payload, signature, secret):
          expected_signature = 'sha256=' + hmac.new(
              secret.encode('utf-8'),
              json.dumps(payload, separators=(',', ':')).encode('utf-8'),
              hashlib.sha256
          ).hexdigest()

          return hmac.compare_digest(signature, expected_signature)

      # Flask example
      @app.route('/webhooks', methods=['POST'])
      def handle_webhook():
          signature = request.headers.get('X-Webhook-Signature')
          secret = os.environ.get('WEBHOOK_SECRET')

          if not verify_webhook_signature(request.json, signature, secret):
              return 'Invalid signature', 401

          event_type = request.headers.get('X-Webhook-Event')
          print(f'Received event: {event_type}', request.json)

          return 'OK', 200
      ```

      ### Important Security Notes

      - **Always verify the signature** before processing webhook data
      - Use a **timing-safe comparison** function to prevent timing attacks
      - Store your webhook secret securely (environment variables, secrets manager)
      - If your secret is compromised, regenerate it immediately using the `/api/v1/user-webhooks/{id}/regenerate-secret` endpoint
      - Webhook requests timeout after 10 seconds
      - Failed deliveries are retried up to 3 times (after 1 min, 5 min, 15 min)
      - Return a 2xx status code within 10 seconds to acknowledge receipt

paths:
 
  # ==========================================
  # DOMAINS
  # ==========================================
  /api/v1/domains:
    get:
      tags:
        - Domains
      summary: List all domains
      description: Get a list of all domains belonging to the authenticated merchant
      operationId: listDomains
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [active, inactive]
          description: Filter by domain status
        - name: recommendation
          in: query
          schema:
            type: string
            enum: [pass, fail, review]
          description: Filter by recommendation status
        - name: industry
          in: query
          schema:
            type: string
            maxLength: 255
          description: Filter by industry
        - name: businessType
          in: query
          schema:
            type: string
            maxLength: 255
          description: Filter by business type
        - name: foundedYear
          in: query
          schema:
            type: integer
            minimum: 1800
          description: Filter by founded year
        - name: search
          in: query
          schema:
            type: string
            maxLength: 255
          description: Search by domain or name
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [created_at, updated_at, domain, name, recommendation, last_checked_at, industry, business_type, founded_year]
            default: created_at
          description: Field to sort by
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          description: Sort order
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Page number
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
          description: Number of items per page
      responses:
        '200':
          description: Domains retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Domains retrieved successfully
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Domain'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    post:
      tags:
        - Domains
      summary: Add a new domain
      description: >
        Register a new domain and start monitoring immediately.
        An initial web presence verification is attempted asynchronously.
        Verification may fail, timeout, or return incomplete data and does not
        affect the monitoring status of the domain.
      operationId: createDomain
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - domain
              properties:
                domain:
                  type: string
                  example: example.com
                  description: Domain name without protocol
                name:
                  type: string
                  example: My Business Website
                  description: Friendly name for the domain
                checkFrequency:
                  type: string
                  enum: ['7', '30', '90']
                  default: '7'
                  description: |
                    Monitoring frequency in days:
                    - '7': Weekly monitoring (every 7 days)
                    - '30': Monthly monitoring (every 30 days)
                    - '90': Quarterly monitoring (every 90 days)

                    This value is sent to the monitoring provider to configure the monitoring package frequency.
      responses:
        '201':
          description: Domain created successfully and initial verification attempted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Domain created and verification initiated
                  data:
                    $ref: '#/components/schemas/Domain'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '409':
          description: Domain already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/domains/{id}:
    get:
      tags:
        - Domains
      summary: Get domain by ID
      description: >
        Retrieve detailed information about a specific domain, including the
        current verification recommendation. This endpoint should be used to
        check the latest verification status after domain creation or a manual
        verification retry.
      operationId: getDomainById
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Domain retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/Domain'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/domains/{id}/details:
    get:
      tags:
        - Domains
      summary: Get Web presence details with raw provider data
      description: |
        Get comprehensive verification details including the complete raw
        response from the provider.

        The raw provider response may be null if verification failed or timed out.
        Availability of raw data depends on provider response and does not affect
        monitoring status.
      operationId: getDomainDetails
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Domain details with raw provider data retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    allOf:
                      - $ref: '#/components/schemas/Domain'
                      - type: object
                        properties:
                          web_presence:
                            type: object
                            properties:
                              recommendation:
                                type: string
                                enum: [pass, fail, review]
                              businessName:
                                type: string
                              industry:
                                type: string
                              businessType:
                                type: string
                              foundedYear:
                                type: integer
                              provider:
                                type: string
                              rawData:
                                type: object
                                description: Complete raw JSON response from the verification provider
                                nullable: true
                              providerResponseId:
                                type: string
                                description: Provider's unique response/transaction ID
                                nullable: true
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  
  /api/v1/domains/{id}/check:
    post:
      tags:
        - Domains
      summary: Manually trigger Web Presence Check 
      description: |
        Manually retry the web presence verification for an existing domain.

        This endpoint is intended for cases where the initial verification failed,
        timed out, or returned incomplete data. It re-attempts verification only and
        does not affect monitoring status.

        This operation may take up to 30â€“40 seconds depending on provider response times.
      operationId: recheckDomain
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Domain ID
      responses:
        '200':
          description: Web presence check completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Web presence check completed successfully
                  data:
                    $ref: '#/components/schemas/Domain'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/domains/{id}/stop:
    patch:
      tags:
        - Domains
      summary: Stop monitoring domain
      description: Pause monitoring for this domain
      operationId: stopDomain
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Domain monitoring stopped
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Domain monitoring stopped
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/domains/{id}/start:
    patch:
      tags:
        - Domains
      summary: Start monitoring domain
      description: Resume monitoring for this domain
      operationId: startDomain
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Domain monitoring started
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Domain monitoring started
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  

  # ==========================================
  # USER WEBHOOKS
  # ==========================================
  
  /api/v1/user-webhooks/{id}:
    get:
      tags:
        - User Webhooks
      summary: Get webhook endpoint
      description: Retrieve details of a specific webhook endpoint
      operationId: getWebhookEndpoint
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Webhook endpoint retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/WebhookEndpoint'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

    patch:
      tags:
        - User Webhooks
      summary: Update webhook endpoint
      description: Update webhook endpoint configuration
      operationId: updateWebhookEndpoint
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  format: uri
                events:
                  type: array
                  nullable: true
                  items:
                    type: string
                    enum:
                      - domain.created
                      - business-profile
                      - domain.deleted
                      - business-closed
                      - sentiment
                      - website
                description:
                  type: string
                  maxLength: 500
                enabled:
                  type: boolean
      responses:
        '200':
          description: Webhook endpoint updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: '#/components/schemas/WebhookEndpoint'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/user-webhooks/{id}/test:
    post:
      tags:
        - User Webhooks
      summary: Test webhook endpoint
      description: Send a test webhook to verify the endpoint is working
      operationId: testWebhookEndpoint
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Test webhook sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Test webhook sent successfully
                  data:
                    type: object
                    properties:
                      status:
                        type: string
                        example: success
                      responseStatus:
                        type: integer
                        example: 200
                      durationMs:
                        type: integer
                        example: 245
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/user-webhooks/{id}/regenerate-secret:
    post:
      tags:
        - User Webhooks
      summary: Regenerate webhook secret
      description: Generate a new signing secret for the webhook endpoint
      operationId: regenerateWebhookSecret
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Secret regenerated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Webhook secret regenerated successfully
                  warning:
                    type: string
                    example: Store the new secret securely. It will not be shown again.
                  data:
                    type: object
                    properties:
                      secret:
                        type: string
                        example: new123...
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/user-webhooks/{id}/deliveries:
    get:
      tags:
        - User Webhooks
      summary: View webhook delivery logs
      description: Get delivery logs for a webhook endpoint
      operationId: getWebhookDeliveries
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Delivery logs retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/WebhookDelivery'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/v1/user-webhooks/deliveries:
    get:
      tags:
        - User Webhooks
      summary: List all delivery logs
      description: |
        Get all webhook delivery logs for your account with optional filters.

        Returns delivery logs across all your webhook endpoints.
      operationId: listAllDeliveries
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
          description: Page number
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
          description: Number of items per page
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, success, failed, retrying]
          description: Filter by delivery status
        - name: dateFrom
          in: query
          schema:
            type: string
            format: date-time
          description: Filter deliveries from this date (ISO 8601 format, e.g., 2025-01-01 or 2025-01-01T00:00:00Z)
        - name: dateTo
          in: query
          schema:
            type: string
            format: date-time
          description: Filter deliveries until this date (ISO 8601 format, e.g., 2025-01-31 or 2025-01-31T23:59:59Z)
        - name: domainId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by domain ID
      responses:
        '200':
          description: Delivery logs retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Delivery logs retrieved successfully
                  data:
                    type: array
                    items:
                      allOf:
                        - $ref: '#/components/schemas/WebhookDelivery'
                        - type: object
                          properties:
                            endpointId:
                              type: string
                              format: uuid
                            endpointUrl:
                              type: string
                              format: uri
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

# ==========================================
# COMPONENTS
# ==========================================
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token obtained from login endpoint

  schemas:
    Domain:
      type: object
      properties:
        id:
          type: string
          format: uuid
        domain:
          type: string
          example: example.com
        name:
          type: string
          example: My Business Website
        status:
          type: string
          enum: [active, inactive]
        recommendation:
          type: string
          enum: [pass, fail, review]
          nullable: true
          description: >
            Verification recommendation from the most recent web presence check.
            A null value indicates that verification has not completed or failed.
            Monitoring may still be active when this value is null.
        provider:
          type: string
          example: truebiz
        checkFrequency:
          type: string
          enum: ['7', '30', '90']
          description: |
            Monitoring frequency in days:
            - '7': Weekly monitoring (every 7 days)
            - '30': Monthly monitoring (every 30 days)
            - '90': Quarterly monitoring (every 90 days)

            This value is sent to the monitoring provider (e.g., TrueBiz) to configure the monitoring package frequency.
        lastCheckedAt:
          type: string
          format: date-time
          nullable: true
        nextCheckAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    WebhookEndpoint:
      type: object
      properties:
        id:
          type: string
          format: uuid
        url:
          type: string
          format: uri
          example: https://your-app.com/webhooks
        events:
          type: array
          nullable: true
          items:
            type: string
          example: ["business-closed", "sentiment"]
          description: Subscribed event types. null means all events.
        description:
          type: string
          nullable: true
        enabled:
          type: boolean
        lastDeliveryAt:
          type: string
          format: date-time
          nullable: true
        failedDeliveries:
          type: integer
          description: Consecutive failed delivery count
        totalDeliveries:
          type: integer
        successfulDeliveries:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    WebhookDelivery:
      type: object
      properties:
        id:
          type: string
          format: uuid
        eventType:
          type: string
          example: business-closed
        domainId:
          type: string
          format: uuid
          nullable: true
        attemptNumber:
          type: integer
        status:
          type: string
          enum: [pending, success, failed, retrying]
        responseStatus:
          type: integer
          nullable: true
          example: 200
        durationMs:
          type: integer
          nullable: true
          example: 245
        errorMessage:
          type: string
          nullable: true
        sentAt:
          type: string
          format: date-time
          nullable: true
        completedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    WebhookEvent:
      type: object
      description: |
        Webhook event payload sent to your endpoint.

        Event types indicate domain lifecycle or verification-related updates.
        Events do not guarantee successful verification; consumers should rely
        on the payload data to determine the current verification state.

        **Important:** Always verify the `X-Webhook-Signature` header before processing this payload.
      properties:
        event:
          type: string
          description: The event type
          enum:
            - domain.created
            - business-profile
            - domain.deleted
            - business-closed
            - sentiment
            - website
            - webhook.test
          example: business-closed
        timestamp:
          type: string
          format: date-time
          description: When the event occurred
          example: "2024-01-15T10:30:00Z"
        data:
          type: object
          description: Event-specific data
          properties:
            domainId:
              type: string
              format: uuid
              description: The domain ID (present for domain-related events)
            domain:
              type: string
              description: The domain name
              example: example.com
            recommendation:
              type: string
              enum: [pass, fail, review]
              description: The verification recommendation
            message:
              type: string
              description: Human-readable event description
          additionalProperties: true
      required:
        - event
        - timestamp
        - data
      example:
        event: business-closed
        timestamp: "2024-01-15T10:30:00Z"
        data:
          domainId: "123e4567-e89b-12d3-a456-426614174000"
          domain: example.com
          recommendation: fail
          message: "Business appears to be closed based on verification data"

    Pagination:
      type: object
      properties:
        limit:
          type: integer
        offset:
          type: integer
        total:
          type: integer

    Error:
      type: object
      properties:
        message:
          type: string
        code:
          type: string
        details:
          type: object

  responses:
    UnauthorizedError:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: Authentication required
            code: UNAUTHORIZED

    ValidationError:
      description: Validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: Validation failed
            code: VALIDATION_ERROR
            details:
              email: Email is required

    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: Resource not found
            code: NOT_FOUND

security:
  - BearerAuth: []
